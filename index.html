<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªçc Ti·∫øng Anh C√πng B√©</title>
    <style>
        /* --- 1. C·∫§U H√åNH C·ªê ƒê·ªäNH --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #fdf2e9; 
            margin: 0; padding: 0; 
            height: 100vh; width: 100vw; 
            overflow: hidden; 
            display: flex; flex-direction: column;
        }

        /* --- MENU SCREEN --- */
        #menu-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 100;
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; gap: 20px;
        }
        .menu-title { font-size: 28px; color: #ff6f00; font-weight: bold; margin-bottom: 20px; }
        .btn-menu {
            background: white; border: 2px solid #00A4EF; color: #00A4EF;
            padding: 15px 40px; border-radius: 50px; font-size: 20px; font-weight: bold;
            box-shadow: 0 4px #ccebfd; cursor: pointer; width: 80%;
        }
        .btn-menu:active { transform: scale(0.98); box-shadow: none; }

        /* --- 2. GIAO DI·ªÜN H·ªåC (LEARNING) --- */
        #learning-screen {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            padding: 10px; background: #fff;
            display: none; 
        }

        .top-bar { 
            height: 40px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; flex-shrink: 0;
        }
        .btn-home { background: none; border: none; font-size: 24px; cursor: pointer; }
        .header-title { color: #ff6f00; font-size: 18px; font-weight: bold; }

        .learn-img-wrapper {
            flex: 1; width: 100%; min-height: 0;
            display: flex; align-items: center; justify-content: center;
            margin: 5px 0;
        }
        #learn-img {
            max-width: 100%; max-height: 100%; 
            object-fit: contain; border-radius: 15px;
        }

        .info-area { 
            height: 90px; flex-shrink: 0;
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
        }
        .phonetic { font-size: 22px; color: red; font-weight: bold; font-family: sans-serif; line-height: 1.2; margin-bottom: 5px; }
        .word-display { font-size: 36px; font-weight: bold; color: #333; margin: 0; line-height: 1.2; }

        .sentence-box { display: none; flex-wrap: wrap; justify-content: center; gap: 8px; }
        .s-chunk { text-align: center; }
        .s-ipa { font-size: 14px; color: red; font-weight: bold; }
        .s-txt { font-size: 18px; color: #333; font-weight: bold; }

        .stars { 
            height: 30px; text-align: center; font-size: 28px; color: #e0e0e0; flex-shrink: 0; margin-bottom: 5px;
        }
        .stars.active { color: #FFD700; text-shadow: 0 0 5px orange; transition: color 0.3s; }
        .feedback-text {
            height: 20px; text-align: center; font-size: 16px; color: #555; font-style: italic; margin-bottom: 5px;
        }

        .action-row {
            height: 60px; flex-shrink: 0;
            display: flex; justify-content: center; gap: 15px; align-items: center;
            margin-bottom: 10px;
        }
        .btn-action {
            flex: 1; height: 50px; border-radius: 25px; border: none;
            font-size: 18px; font-weight: bold; cursor: pointer; color: white;
            display: flex; align-items: center; justify-content: center; gap: 5px;
            box-shadow: 0 4px rgba(0,0,0,0.2); max-width: 45%;
        }
        .btn-mic { background: #27ae60; transition: background 0.3s; }
        .btn-listen { background: #2980b9; }
        .btn-game-entry { background: #9b59b6; width: 80%; max-width: none; animation: pulse 1s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }

        .nav-row {
            height: 60px; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px;
        }
        .btn-nav { 
            width: 50px; height: 50px; border-radius: 50%; 
            background: #f39c12; color: white; border: none; 
            font-size: 24px; font-weight: bold; cursor: pointer;
            box-shadow: 0 3px #d35400;
        }
        .btn-nav:active { transform: translateY(2px); box-shadow: none; }

        /* --- 3. GIAO DI·ªÜN GAME --- */
        #game-screen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff3e0; z-index: 50;
            flex-direction: column;
        }

        .game-header {
            height: 60px; display: flex; justify-content: center; align-items: center;
            position: relative; background: rgba(255,255,255,0.8);
        }
        .timer-badge {
            background: white; border: 2px solid #d35400; color: #d35400;
            padding: 5px 20px; border-radius: 20px; font-size: 20px; font-weight: bold;
        }
        .btn-close {
            position: absolute; right: 10px; background: #c0392b; color: white;
            width: 35px; height: 35px; border-radius: 50%; border: none; font-weight: bold;
        }

        .tower-container {
            flex: 1; width: 100%;
            display: flex; flex-direction: column; justify-content: center;
            padding: 10px 0;
        }
        .tower-row {
            flex: 1; width: 100%;
            display: flex; justify-content: center; align-items: center;
            gap: 15px; margin-bottom: 5px;
        }

        .card-flip {
            height: 90%; aspect-ratio: 0.75;
            position: relative; perspective: 1000px;
        }
        .card-inner {
            position: relative; width: 100%; height: 100%;
            transition: transform 0.4s; transform-style: preserve-3d;
            border-radius: 10px; box-shadow: 0 3px 5px rgba(0,0,0,0.3);
        }
        .card-flip.flipped .card-inner { transform: rotateY(180deg); }
        .card-flip.matched .card-inner { opacity: 0; pointer-events: none; }

        .face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #5d4037;
        }
        .front { background: #8d6e63; color: #3e2723; font-size: 5vh; font-weight: 900; }
        .back { background: white; transform: rotateY(180deg); padding: 2px; }
        .back img { width: 90%; height: 90%; object-fit: contain; }
        
        .game-card-text {
            display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;
        }
        .gc-ipa { color: red; font-weight: bold; font-size: 2vh; margin-bottom: 2px; }
        .gc-word { color: #333; font-weight: bold; font-size: 2.5vh; }

        .game-footer {
            height: 80px; display: flex; justify-content: space-around; align-items: center;
            background: white; border-top: 1px solid #ccc;
        }

        #win-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 99;
            flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<div id="menu-screen">
    <div class="menu-title">üìö CH·ªåN B√ÄI H·ªåC</div>
    <button class="btn-menu" onclick="startLesson(15)">B√†i 15: /…™r/ & /…õr/</button>
    <button class="btn-menu" onclick="startLesson(16)">B√†i 16: /a ä/ & /o ä/</button>
</div>

<div id="learning-screen">
    <div class="top-bar">
        <button class="btn-home" onclick="goHome()">üè†</button>
        <div class="header-title">üêª B√© H·ªçc Ti·∫øng Anh üê∞</div>
        <div style="width: 24px;"></div>
    </div>
    
    <div class="learn-img-wrapper">
        <img id="learn-img" src="" alt="H√¨nh ·∫£nh">
    </div>

    <div class="info-area">
        <div id="mode-word">
            <div class="phonetic" id="disp-ipa">...</div>
            <h2 class="word-display" id="disp-text">...</h2>
        </div>
        <div id="mode-sent" class="sentence-box"></div>
    </div>

    <div class="stars" id="stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
    <div class="feedback-text" id="feedback">...</div>

    <div class="action-row" id="action-container">
        <button class="btn-action btn-mic" id="mic-btn" onclick="startListening()">üé§ ƒê·ªçc Ngay</button>
        <button class="btn-action btn-listen" id="btn-replay" onclick="playAudio()">üîä Nghe L·∫°i</button>
    </div>

    <div class="nav-row">
        <button class="btn-nav" onclick="nav(-1)">‚óÄ</button>
        <button class="btn-nav" onclick="nav(1)">‚ñ∂</button>
    </div>
</div>

<div id="game-screen">
    <div class="game-header">
        <div class="timer-badge">‚è±Ô∏è <span id="timer">00:00</span></div>
        <button class="btn-close" onclick="exitGame()">‚úï</button>
    </div>

    <div id="tower" class="tower-container"></div>

    <div class="game-footer">
        <button class="btn-action btn-listen" style="width: 40%;" onclick="playLastCard()">üîä Nghe</button>
        <button class="btn-action btn-nav" style="width: 40%; border-radius: 25px; font-size: 18px;" onclick="initGame()">‚Üª Ch∆°i l·∫°i</button>
    </div>

    <div id="win-modal">
        <h1 style="color:green; font-size:32px;">XU·∫§T S·∫ÆC! üéâ</h1>
        <p id="win-msg" style="font-size:18px; color:#555; margin-bottom: 20px;">B·∫°n ƒë√£ ho√†n th√†nh tr√≤ ch∆°i trong 00:00</p>
        <button class="btn-action btn-nav" style="width:auto; padding: 0 30px;" onclick="initGame()">Ch∆°i l·∫°i</button>
        <br>
        <button class="btn-action btn-listen" style="width:auto; padding: 0 30px;" onclick="exitGame()">B√†i Ti·∫øp ‚û°</button>
    </div>
</div>

<script>
    // --- D·ªÆ LI·ªÜU B√ÄI H·ªåC (ƒê√É B·ªî SUNG DANH S√ÅCH SIMILAR) ---
    
    // B√†i 15
    const lesson15 = [
        { word: "beer", ipa: "/…™r/", img: "beer.png", type: "word", speakText: "beer", similar: ["bear", "beard", "pier", "beers"] }, 
        { word: "deer", ipa: "/…™r/", img: "deer.png", type: "word", speakText: "deer", similar: ["dear", "dare", "tear", "there"] }, 
        { word: "cheer", ipa: "/…™r/", img: "cheer.png", type: "word", speakText: "cheer", similar: ["chair", "cheers", "sheer", "chia"] }, 
        { word: "tear", ipa: "/…™r/", img: "tear.png", type: "word", speakText: "tier", similar: ["tier", "tea", "here", "tears", "year"] }, 
        { word: "ear", ipa: "/…™r/", img: "ear.png", type: "word", speakText: "ear", similar: ["year", "here", "ears", "air", "yeah", "hear", "near"] }, 
        { word: "bear", ipa: "/…õr/", img: "bear.png", type: "word", speakText: "bear", similar: ["bare", "beer", "pair", "bears", "bar"] }, 
        { word: "pear", ipa: "/…õr/", img: "pear.png", type: "word", speakText: "pear", similar: ["pair", "pare", "bear", "pears"] }, 
        { word: "share", ipa: "/…õr/", img: "share.png", type: "word", speakText: "share", similar: ["chair", "sure", "cher", "shared"] }, 
        { word: "stair", ipa: "/…õr/", img: "stair.png", type: "word", speakText: "stair", similar: ["stare", "star", "stairs", "stay"] }, 
        { word: "chair", ipa: "/…õr/", img: "chair.png", type: "word", speakText: "chair", similar: ["cheer", "share", "chairs", "care"] },
        { type: "sent", text: "The deer is near the chair", img: "sentence_deer.png", parts: [{t:'The',p:'√∞…ô'},{t:'deer',p:'…™r'},{t:'is',p:'…™z'},{t:'near',p:'…™r'},{t:'the',p:'√∞…ô'},{t:'chair.',p:'t É …õr'}] },
        { type: "sent", text: "The bear shares the pear", img: "sentence_bear.png", parts: [{t:'The',p:'√∞…ô'},{t:'bear',p:'…õr'},{t:'shares',p:' É …õr'},{t:'the',p:'√∞…ô'},{t:'pear.',p:'…õr'}] },
        { type: "game", title: "Game /…™r/", pairs: ["beer", "deer", "cheer", "tear", "ear"] },
        { type: "game", title: "Game /…õr/", pairs: ["bear", "pear", "share", "stair", "chair"] }
    ];

    // B√†i 16 (ƒê√£ th√™m similar cho √¢m /a ä/ v√† /o ä/)
    const lesson16 = [
        // √Çm /a ä/
        { word: "shower", ipa: "/a ä …ôr/", img: "shower.png", type: "word", speakText: "shower", similar: ["show", "power", "hour", "sower"] },
        { word: "shout", ipa: "/a ä/", img: "shout.png", type: "word", speakText: "shout", similar: ["out", "shut", "south", "scout"] },
        { word: "cow", ipa: "/a ä/", img: "cow.png", type: "word", speakText: "cow", similar: ["how", "now", "count", "call"] },
        { word: "brown", ipa: "/a ä/", img: "brown.png", type: "word", speakText: "brown", similar: ["down", "frown", "round", "ground"] },
        { word: "tower", ipa: "/a ä …ôr/", img: "tower.png", type: "word", speakText: "tower", similar: ["power", "towel", "flower"] },
        // √Çm /o ä/
        { word: "toe", ipa: "/o ä/", img: "toe.png", type: "word", speakText: "toe", similar: ["tow", "to", "tall"] },
        { word: "boat", ipa: "/o ä/", img: "boat.png", type: "word", speakText: "boat", similar: ["boot", "bot", "bought", "bow"] },
        { word: "coat", ipa: "/o ä/", img: "coat.png", type: "word", speakText: "coat", similar: ["cat", "cot", "code", "cold"] },
        { word: "phone", ipa: "/f o ä/", img: "phone.png", type: "word", speakText: "phone", similar: ["fun", "foam", "home", "fone"] },
        { word: "goat", ipa: "/o ä/", img: "goat.png", type: "word", speakText: "goat", similar: ["got", "go", "good", "ghost"] },
        // C√¢u
        { type: "sent", text: "The brown cow shouts at the mouse", img: "sentence_cow.png", 
          parts: [{t:"The",p:"√∞…ô"},{t:"brown",p:"a ä"},{t:"cow",p:"a ä"},{t:"shouts",p:"a ä"},{t:"at",p:"√¶"},{t:"the",p:"√∞…ô"},{t:"mouse.",p:"a ä"}] 
        },
        { type: "sent", text: "Joe shows the slow goat the soap", img: "sentence_joe.png", 
          parts: [{t:"Joe",p:"d í o ä"},{t:"shows",p:" É o ä z"},{t:"the",p:"√∞…ô"},{t:"slow",p:"o ä"},{t:"goat",p:"o ä"},{t:"the",p:"√∞…ô"},{t:"soap.",p:"o ä"}] 
        },
        // Game
        { type: "game", title: "Game /a ä/", pairs: ["cow", "brown", "shout", "tower", "shower"] },
        { type: "game", title: "Game /o ä/", pairs: ["toe", "boat", "coat", "phone", "goat"] }
    ];

    let currentData = [];
    let idx = 0;
    let timerInt, sec=0, flipped=false, lock=false, c1, c2, match=0, lastWord="";
    let recognition;

    // --- MENU LOGIC ---
    function startLesson(num) {
        currentData = (num === 15) ? lesson15 : lesson16;
        idx = 0;
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('learning-screen').style.display = 'flex';
        render(0);
    }

    function goHome() {
        document.getElementById('learning-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('menu-screen').style.display = 'flex';
        window.speechSynthesis.cancel();
    }

    // --- LOGIC THU √ÇM TH·∫¨T (WEB SPEECH API) ---
    function startListening() {
        // 1. Ki·ªÉm tra h·ªó tr·ª£
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ thu √¢m. Vui l√≤ng d√πng Google Chrome ho·∫∑c Safari.");
            return;
        }

        // 2. Setup UI
        const btn = document.getElementById('mic-btn');
        const feedback = document.getElementById('feedback');
        const stars = document.getElementById('stars');

        btn.disabled = true;
        btn.innerText = "üëÇ ƒêang nghe...";
        btn.style.backgroundColor = "#e74c3c";
        feedback.innerText = "B√© h√£y ƒë·ªçc to nh√©...";
        stars.innerText = "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ";
        stars.classList.remove('active');

        // 3. C·∫•u h√¨nh Recognition
        recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 10; // L·∫•y nhi·ªÅu k·∫øt qu·∫£ ƒë·ªÉ tƒÉng kh·∫£ nƒÉng ƒë√∫ng

        recognition.start();

        // X·ª≠ l√Ω k·∫øt qu·∫£
        recognition.onresult = function(event) {
            const results = event.results[0];
            const heardWords = [];
            for (let i = 0; i < results.length; i++) {
                heardWords.push(results[i].transcript.toLowerCase());
            }
            checkResultSmart(heardWords);
        };

        recognition.onerror = function(event) {
            feedback.innerText = "Kh√¥ng nghe r√µ, th·ª≠ l·∫°i nh√©!";
            resetMicBtn();
        };

        recognition.onend = function() {
            if (btn.innerText.includes("ƒêang nghe")) resetMicBtn();
        };
    }

    function resetMicBtn() {
        const btn = document.getElementById('mic-btn');
        btn.disabled = false;
        btn.innerText = "üé§ ƒê·ªçc Ngay";
        btn.style.backgroundColor = "#27ae60";
    }

    // --- LOGIC KI·ªÇM TRA K·∫æT QU·∫¢ (FUZZY MATCHING) ---
    function checkResultSmart(heardWords) {
        const item = currentData[idx];
        const targetText = (item.speakText || item.word || item.text).toLowerCase();
        
        // T·∫°o danh s√°ch c√°c t·ª´ ch·∫•p nh·∫≠n ƒë∆∞·ª£c
        let acceptedWords = [targetText.replace(/[.,!?]/g, "")];
        
        // N·∫øu l√† t·ª´ ƒë∆°n, th√™m danh s√°ch similar
        if (item.type !== 'sent' && item.similar) {
            item.similar.forEach(w => acceptedWords.push(w.toLowerCase()));
        }

        // 1. Ki·ªÉm tra kh·ªõp ch√≠nh x√°c ho·∫∑c kh·ªõp t·ª´ t∆∞∆°ng t·ª± (cho t·ª´ ƒë∆°n)
        let isMatch = false;
        if (item.type !== 'sent') {
            isMatch = heardWords.some(heard => {
                const cleanHeard = heard.replace(/[.,!?]/g, "");
                return acceptedWords.some(acc => cleanHeard.includes(acc) || acc === cleanHeard);
            });
        } 
        // 2. Ki·ªÉm tra c√¢u (ƒê·ªô kh√≥ th·∫•p: Nghe ƒë∆∞·ª£c > 50% t·ª´ kho√° l√† ƒë·∫°t)
        else {
            const targetKeywords = targetText.split(" ");
            // L·∫•y k·∫øt qu·∫£ nghe t·ªët nh·∫•t (k·∫øt qu·∫£ ƒë·∫ßu ti√™n th∆∞·ªùng chu·∫©n nh·∫•t)
            const bestGuess = heardWords[0]; 
            let matchCount = 0;
            targetKeywords.forEach(kw => {
                if (bestGuess.includes(kw.replace(/[.,!?]/g, ""))) matchCount++;
            });
            
            // N·∫øu ƒë√∫ng tr√™n 60% s·ªë t·ª´ -> OK
            if (matchCount >= targetKeywords.length * 0.6) isMatch = true;
        }

        if (isMatch) {
            showResult(5, "Tuy·ªát v·ªùi! Ch√≠nh x√°c!");
        } else {
            showResult(2, "C·ªë l√™n, th·ª≠ l·∫°i n√†o!");
        }
    }

    function showResult(starCount, msg) {
        const stars = document.getElementById('stars');
        const feedback = document.getElementById('feedback');
        
        let s = ""; 
        for (let i=0; i<5; i++) s += (i<starCount) ? "‚≠ê" : "‚òÜ";
        
        stars.innerText = s;
        if(starCount === 5) stars.classList.add('active');
        
        feedback.innerText = msg;
        
        if (starCount === 5) speak("Excellent!");
        resetMicBtn();
    }

    // --- RENDER GIAO DI·ªÜN ---
    function render(i) {
        if(i < 0 || i >= currentData.length) return;
        idx = i;
        const item = currentData[i];

        // Reset UI
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('learning-screen').style.display = 'flex';
        document.getElementById('win-modal').style.display = 'none';
        
        document.getElementById('stars').innerText = "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ";
        document.getElementById('stars').classList.remove('active');
        document.getElementById('feedback').innerText = "...";

        const imgEl = document.getElementById('learn-img');
        const btnContainer = document.getElementById('action-container');

        if(item.type === 'game') {
            imgEl.src = 'https://img.icons8.com/color/500/controller.png';
            document.getElementById('disp-text').innerText = item.title;
            document.getElementById('disp-ipa').innerText = "";
            document.getElementById('mode-sent').style.display = 'none';
            document.getElementById('mode-word').style.display = 'block';
            
            btnContainer.innerHTML = `<button class="btn-action btn-game-entry" onclick="enterGame()">üöÄ B·∫Øt ƒê·∫ßu Ch∆°i</button>`;
        } else {
            imgEl.src = item.img;
            btnContainer.innerHTML = `
                <button class="btn-action btn-mic" id="mic-btn" onclick="startListening()">üé§ ƒê·ªçc Ngay</button>
                <button class="btn-action btn-listen" id="btn-replay" onclick="playAudio()">üîä Nghe L·∫°i</button>
            `;

            if(item.type === 'sent') {
                document.getElementById('mode-word').style.display = 'none';
                const box = document.getElementById('mode-sent');
                box.style.display = 'flex'; box.innerHTML = '';
                item.parts.forEach(p => {
                    box.innerHTML += `<div class="s-chunk"><div class="s-ipa">${p.p}</div><div class="s-txt">${p.t}</div></div>`;
                });
            } else {
                document.getElementById('mode-word').style.display = 'block';
                document.getElementById('mode-sent').style.display = 'none';
                document.getElementById('disp-text').innerText = item.word;
                document.getElementById('disp-ipa').innerText = item.ipa.replace(/\//g, '');
            }
            setTimeout(playAudio, 500);
        }
    }

    function nav(d) { render(idx + d); }
    
    function playAudio() {
        const item = currentData[idx];
        if(item.type !== 'game') speak(item.speakText || item.word || item.text);
    }

    function speak(txt) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = 'en-US';
        window.speechSynthesis.speak(u);
    }

    // --- GAME LOGIC ---
    function enterGame() {
        document.getElementById('learning-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex';
        initGame();
    }

    function initGame() {
        const item = currentData[idx];
        const tower = document.getElementById('tower');
        tower.innerHTML = '';
        document.getElementById('win-modal').style.display = 'none';

        clearInterval(timerInt);
        sec=0; document.getElementById('timer').innerText = "00:00";
        startTimer();

        flipped=false; lock=false; c1=null; c2=null; match=0; lastWord="Choose";

        let cards = [];
        item.pairs.forEach(key => {
            let original = currentData.find(d => d.word === key);
            if(original) {
                cards.push({ id: key, type: 'img', content: `<img src="${original.img}">`, speak: original.speakText || key });
                let ipaClean = original.ipa.replace(/\//g, '');
                let htmlText = `<div class="game-card-text"><div class="gc-ipa">${ipaClean}</div><div class="gc-word">${key}</div></div>`;
                cards.push({ id: key, type: 'text', content: htmlText, speak: original.speakText || key });
            }
        });
        cards.sort(() => 0.5 - Math.random());

        const rows = [3, 2, 3, 2];
        let cCount = 0;
        let num = 1;

        rows.forEach(cnt => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'tower-row';
            for(let k=0; k<cnt; k++) {
                const c = cards[cCount];
                const el = document.createElement('div');
                el.className = 'card-flip';
                el.dataset.speak = c.speak;
                el.dataset.id = c.id;
                el.innerHTML = `<div class="card-inner"><div class="face front">${num}</div><div class="face back">${c.content}</div></div>`;
                el.onclick = function() { cardClick(this); };
                rowDiv.appendChild(el);
                cCount++; num++;
            }
            tower.appendChild(rowDiv);
        });
    }

    function cardClick(el) {
        if(lock || el===c1 || el.classList.contains('matched')) return;
        el.classList.add('flipped');
        lastWord = el.dataset.speak;
        speak(lastWord);
        if(!flipped) { flipped=true; c1=el; } else { c2=el; check(); }
    }

    function check() {
        lock=true;
        if(c1.dataset.id === c2.dataset.id) {
            setTimeout(() => {
                c1.classList.add('matched'); c2.classList.add('matched');
                match++; reset();
                if(match===5) win();
            }, 600);
        } else {
            setTimeout(() => {
                c1.classList.remove('flipped'); c2.classList.remove('flipped');
                reset();
            }, 1000);
        }
    }

    function reset() { flipped=false; lock=false; c1=null; c2=null; }
    
    function startTimer() {
        timerInt = setInterval(() => {
            sec++;
            let m=Math.floor(sec/60).toString().padStart(2,'0');
            let s=(sec%60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }, 1000);
    }

    function win() {
        clearInterval(timerInt);
        let timeStr = document.getElementById('timer').innerText;
        document.getElementById('win-msg').innerText = "B·∫°n ƒë√£ ho√†n th√†nh tr√≤ ch∆°i trong " + timeStr;
        document.getElementById('win-modal').style.display = 'flex';
        speak("Excellent job!");
    }

    function playLastCard() { speak(lastWord); }
    
    function exitGame() { 
        clearInterval(timerInt); 
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('learning-screen').style.display = 'flex';
        nav(-1); 
    }
</script>
</body>
</html>
