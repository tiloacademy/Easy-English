<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Há»c tiáº¿ng Anh tháº­t dá»…</title>
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #e0f7fa; text-align: center; padding: 15px; }
        .card { background: white; border-radius: 20px; padding: 20px; max-width: 450px; margin: 0 auto; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 5px solid #FFD700; }
        
        .img-box { width: 220px; height: 220px; margin: 0 auto; overflow: hidden; border-radius: 15px; border: 2px dashed #ddd; background: #fff; }
        img { width: 100%; height: 100%; object-fit: contain; }
        
        h1 { color: #ff6f00; font-size: 24px; margin: 10px 0; }
        h2 { color: #333; font-size: 40px; margin: 5px 0; letter-spacing: 2px; }
        
        .btn { border: none; border-radius: 50px; cursor: pointer; margin: 10px 5px; box-shadow: 0 4px #999; transition: 0.1s; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
        .btn:active { transform: translateY(4px); box-shadow: 0 0 #666; }
        .btn:disabled { background-color: #ccc !important; color: #666; cursor: not-allowed; box-shadow: none; transform: none; }

        .btn-mic { background-color: #4CAF50; padding: 15px 30px; font-size: 20px; width: 80%; }
        .btn-sample { background-color: #2196F3; padding: 10px 20px; font-size: 16px; }
        .btn-nav { background-color: #FF9800; padding: 10px; font-size: 18px; width: 45px; height: 45px; border-radius: 50%; }

        .stars { font-size: 40px; color: #FFD700; height: 50px; margin: 5px 0; }
        .feedback { font-size: 16px; color: #555; min-height: 40px; margin-bottom: 10px; font-style: italic; padding: 5px; border: 1px dotted #ccc; border-radius: 5px;}
        .phonetic { color: #888; font-size: 20px; margin-bottom: 10px; font-family: 'Times New Roman', serif; }
        
        .listening { animation: pulse 1.5s infinite; background-color: #ff5722 !important; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div class="card">
    <h1>ğŸ» Há»c phÃ¡t Ã¢m ğŸ°</h1>
    
    <div class="img-box">
        <img id="word-img" src="" alt="Word Image" onerror="this.onerror=null; this.src='https://via.placeholder.com/200?text=No+Image';">
    </div>

    <h2 id="word-text">WORD</h2>
    <div class="phonetic" id="phonetic">/IPA/</div>

    <button class="btn btn-sample" onclick="playSampleSafe()">ğŸ”Š Nghe máº«u</button>

    <div class="stars" id="stars">â˜†â˜†â˜†â˜†â˜†</div>
    <div class="feedback" id="feedback">Äang táº£i...</div>

    <button id="mic-btn" class="btn btn-mic" onclick="startListeningSafe()">ğŸ¤ Äá»c Ngay</button>

    <div style="margin-top: 20px; display: flex; justify-content: space-between; padding: 0 10px;">
        <button class="btn btn-nav" onclick="prevWord()">â—€</button>
        <button class="btn btn-nav" onclick="nextWord()">â–¶</button>
    </div>
</div>

<script>
    // --- 1. Dá»® LIá»†U & Cáº¤U HÃŒNH THÃ”NG MINH ---
    /*
      - word: Tá»« hiá»ƒn thá»‹ trÃªn mÃ n hÃ¬nh
      - ipa: PhiÃªn Ã¢m
      - img: TÃªn file áº£nh
      - speakText: (Máº¹o) Tá»« Ä‘á»ƒ mÃ¡y Ä‘á»c Ä‘Ãºng Ã¢m (náº¿u tá»« gá»‘c bá»‹ Ä‘á»c sai)
      - similar: Danh sÃ¡ch cÃ¡c tá»« "nghe gáº§n giá»‘ng" mÃ  váº«n cháº¥m 5 sao (Ä‘á»ƒ bÃ© dá»… tháº¯ng hÆ¡n)
    */
    const words = [
        { 
            word: "ear", ipa: "/Éªr/", img: "ear.png", 
            speakText: "ear", 
            similar: ["year", "here", "ears", "air"] // Ear hay bá»‹ nghe nháº§m thÃ nh Year/Here
        }, 
        { 
            word: "beer", ipa: "/Éªr/", img: "beer.png", 
            speakText: "beer", 
            similar: ["bear", "beard", "pier"] 
        }, 
        { 
            word: "deer", ipa: "/Éªr/", img: "deer.png", 
            speakText: "deer", 
            similar: ["dear", "dare", "tear"] 
        }, 
        { 
            word: "cheer", ipa: "/Éªr/", img: "cheer.png", 
            speakText: "cheer", 
            similar: ["chair", "cheers", "sheer"] 
        }, 
        { 
            word: "tear", ipa: "/Éªr/", img: "tear.png", 
            speakText: "tier", // <--- Máº¸O: Äá»c lÃ  "tier" Ä‘á»ƒ ra Ã¢m /Éªr/ (nÆ°á»›c máº¯t)
            similar: ["tier", "tea", "here"] 
        }, 
        { 
            word: "bear", ipa: "/É›r/", img: "bear.png", 
            speakText: "bear", 
            similar: ["bare", "beer", "pair"] 
        }, 
        { 
            word: "pear", ipa: "/É›r/", img: "pear.png", 
            speakText: "pear", 
            similar: ["pair", "pare", "bear"] 
        }, 
        { 
            word: "share", ipa: "/É›r/", img: "share.png", 
            speakText: "share", 
            similar: ["chair", "sure", "cher"] 
        }, 
        { 
            word: "stair", ipa: "/É›r/", img: "stair.png", 
            speakText: "stair", 
            similar: ["stare", "star", "stairs"] 
        }, 
        { 
            word: "chair", ipa: "/É›r/", img: "chair.png", 
            speakText: "chair", 
            similar: ["cheer", "share", "chairs"] 
        }  
    ];

    let currentIndex = 0;
    let recognition;
    let recognitionTimeout;
    let audioWin, audioCorrect, audioWrong;

    // --- 2. HÃ€M KHá»I Táº O ---
    window.onload = function() {
        try {
            document.getElementById('feedback').innerText = "Sáºµn sÃ ng! Báº¥m nÃºt Ä‘á»ƒ há»c.";
            loadWord(0);
            audioWin = new Audio("win.mp3");
            audioCorrect = new Audio("correct.mp3");
            audioWrong = new Audio("wrong.mp3");
        } catch (e) {
            console.log("Lá»—i táº£i trang: " + e);
        }
    };

    function loadWord(index) {
        document.getElementById('word-text').innerText = words[index].word.toUpperCase();
        document.getElementById('phonetic').innerText = words[index].ipa;
        document.getElementById('word-img').src = words[index].img;
        resetState();
    }

    function resetState() {
        document.getElementById('stars').innerText = "â˜†â˜†â˜†â˜†â˜†";
        document.getElementById('mic-btn').disabled = false;
        document.getElementById('mic-btn').className = "btn btn-mic";
        document.getElementById('mic-btn').innerText = "ğŸ¤ Äá»c Ngay";
        clearTimeout(recognitionTimeout);
    }

    function nextWord() {
        if (currentIndex < words.length - 1) { currentIndex++; loadWord(currentIndex); }
    }

    function prevWord() {
        if (currentIndex > 0) { currentIndex--; loadWord(currentIndex); }
    }

    // --- 3. NGHE MáºªU (DÃ¹ng tá»« thay tháº¿ Ä‘á»ƒ phÃ¡t Ã¢m chuáº©n) ---
    function playSampleSafe() {
        try {
            window.speechSynthesis.cancel();
            
            // DÃ¹ng tá»« speakText Ä‘á»ƒ Ä‘á»c (vÃ­ dá»¥ Tear -> Ä‘á»c lÃ  Tier)
            const textToSpeak = words[currentIndex].speakText || words[currentIndex].word;
            
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'en-US';
            utterance.rate = 0.8;
            
            utterance.onerror = function(e) { 
                document.getElementById('feedback').innerText = "Lá»—i Ä‘á»c (Kiá»ƒm tra loa).";
            }
            window.speechSynthesis.speak(utterance);
        } catch (e) {
            alert("Lá»—i nÃºt nghe: " + e.message);
        }
    }

    // --- 4. MIC & LOGIC CHáº¤M ÄIá»‚M THÃ”NG MINH ---
    function startListeningSafe() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("Lá»—i: HÃ£y dÃ¹ng Google Chrome (Android) hoáº·c Safari (iPhone).");
            return;
        }

        try {
            window.speechSynthesis.cancel();

            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 5; // Láº¥y 5 phÆ°Æ¡ng Ã¡n mÃ¡y nghe Ä‘Æ°á»£c Ä‘á»ƒ tÄƒng cÆ¡ há»™i Ä‘Ãºng
            recognition.continuous = false;

            document.getElementById('mic-btn').innerText = "ğŸ‘‚ Äang nghe...";
            document.getElementById('mic-btn').className = "btn btn-mic listening";
            document.getElementById('mic-btn').disabled = true;
            document.getElementById('feedback').innerText = "Báº¡n Ä‘á»c to lÃªn nhÃ©...";

            recognition.start();

            clearTimeout(recognitionTimeout);
            recognitionTimeout = setTimeout(() => {
                try { recognition.stop(); } catch(e){}
                document.getElementById('feedback').innerText = "Háº¿t giá»! Báº¡n thá»­ láº¡i nhÃ©.";
                resetBtn();
            }, 5000);

            recognition.onresult = function(event) {
                clearTimeout(recognitionTimeout);
                
                // Láº¥y danh sÃ¡ch táº¥t cáº£ cÃ¡c tá»« mÃ¡y nghe Ä‘Æ°á»£c (hy vá»ng cÃ³ tá»« Ä‘Ãºng trong Ä‘Ã³)
                let heardWords = [];
                for(let i = 0; i < event.results[0].length; i++) {
                    heardWords.push(event.results[0][i].transcript.toLowerCase());
                }
                
                checkResultSmart(heardWords);
            };

            recognition.onerror = function(event) {
                clearTimeout(recognitionTimeout);
                if (event.error === 'not-allowed') {
                    alert("Báº¡n hÃ£y báº¥m 'Cho phÃ©p' Micro nhÃ©.");
                } else if (event.error === 'no-speech') {
                    document.getElementById('feedback').innerText = "KhÃ´ng nghe tháº¥y tiáº¿ng...";
                } else {
                    // CÃ¡c lá»—i khÃ¡c thÃ¬ bá» qua cho bÃ© Ä‘á»¡ sá»£, chá»‰ reset nÃºt
                    document.getElementById('feedback').innerText = "Thá»­ láº¡i nÃ o!";
                }
                resetBtn();
            };

            recognition.onend = function() {
                if(document.getElementById('mic-btn').disabled && document.getElementById('stars').innerText === "â˜†â˜†â˜†â˜†â˜†") {
                    resetBtn();
                }
            };

        } catch (e) {
            resetBtn();
        }
    }

    // --- LOGIC CHáº¤M ÄIá»‚M Má»šI (Dá»„ HÆ N) ---
    function checkResultSmart(heardWords) {
        const currentData = words[currentIndex];
        const targetWord = currentData.word.toLowerCase();
        const validList = currentData.similar || []; // Danh sÃ¡ch cÃ¡c tá»« cháº¥p nháº­n Ä‘Æ°á»£c
        
        // 1. Kiá»ƒm tra 5 sao: Náº¿u tá»« Ä‘Ãºng Náº°M TRONG nhá»¯ng gÃ¬ mÃ¡y nghe Ä‘Æ°á»£c
        // Hoáº·c mÃ¡y nghe ra tá»« náº±m trong danh sÃ¡ch "gáº§n giá»‘ng" (similar)
        let isPerfect = heardWords.some(w => w.includes(targetWord) || validList.includes(w));

        if (isPerfect) {
            showResult(5, "Tuyá»‡t vá»i! ChÃ­nh xÃ¡c! ğŸ‰");
            return;
        }

        // 2. Kiá»ƒm tra 3-4 sao: Láº¥y tá»« rÃµ nháº¥t mÃ¡y nghe Ä‘Æ°á»£c Ä‘á»ƒ so sÃ¡nh Ã¢m Ä‘áº§u
        let bestGuess = heardWords[0];
        if (bestGuess.charAt(0) === targetWord.charAt(0)) {
             // ÄÃºng Ã¢m Ä‘áº§u -> Cho 4 sao khÃ­ch lá»‡ (Thay vÃ¬ 3)
            showResult(4, "Gáº§n Ä‘Ãºng rá»“i! (" + bestGuess + ")");
        } else {
            // Sai hoÃ n toÃ n -> Cho 2 sao an á»§i (Thay vÃ¬ 1)
            showResult(2, "Cá»‘ lÃªn! MÃ¡y nghe lÃ : " + bestGuess);
        }
    }

    function showResult(starCount, message) {
        let stars = "";
        for (let i = 0; i < 5; i++) {
            stars += (i < starCount) ? "â­" : "â˜†";
        }
        document.getElementById('stars').innerText = stars;
        document.getElementById('feedback').innerText = message;
        
        playSoundSafe(starCount);
        resetBtn();
    }

    function resetBtn() {
        document.getElementById('mic-btn').className = "btn btn-mic";
        document.getElementById('mic-btn').disabled = false;
        document.getElementById('mic-btn').innerText = "ğŸ¤ Äá»c Láº¡i";
    }

    function playSoundSafe(starCount) {
        try {
            if(audioWin) { audioWin.pause(); audioWin.currentTime = 0; }
            if(audioCorrect) { audioCorrect.pause(); audioCorrect.currentTime = 0; }
            if(audioWrong) { audioWrong.pause(); audioWrong.currentTime = 0; }

            let soundToPlay;
            if (starCount === 5) soundToPlay = audioWin;
            else if (starCount >= 3) soundToPlay = audioCorrect;
            else soundToPlay = audioWrong; // 1-2 sao phÃ¡t nháº¡c sai

            if(soundToPlay) {
                soundToPlay.play().catch(e => console.log("Audio play err"));
            }
        } catch (e) {}
    }
</script>

</body>
</html>
