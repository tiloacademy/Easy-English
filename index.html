<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc ti·∫øng Anh th·∫≠t d·ªÖ</title>
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #e0f7fa; text-align: center; padding: 15px; }
        .card { background: white; border-radius: 20px; padding: 20px; max-width: 500px; margin: 0 auto; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 5px solid #FFD700; }
        
        .img-box { width: 100%; height: 220px; margin: 0 auto; overflow: hidden; border-radius: 15px; border: 2px dashed #ddd; background: #fff; display: flex; align-items: center; justify-content: center; }
        img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        h1 { color: #ff6f00; font-size: 24px; margin: 10px 0; }
        
        /* Style cho T·ª´ ƒë∆°n */
        h2 { color: #333; font-size: 45px; margin: 5px 0; letter-spacing: 2px; }
        .phonetic { color: #888; font-size: 20px; margin-bottom: 10px; font-family: 'Times New Roman', serif; }

        /* Style m·ªõi cho C√¢u (IPA n·∫±m tr√™n ch·ªØ) */
        .sentence-container { display: none; justify-content: center; flex-wrap: wrap; gap: 10px; margin: 10px 0; }
        .word-block { display: flex; flex-direction: column; align-items: center; }
        .ipa-top { color: #ff3b30; font-size: 18px; font-weight: bold; margin-bottom: -5px; font-family: sans-serif; }
        .text-bottom { color: #000; font-size: 32px; font-weight: normal; }
        
        .btn { border: none; border-radius: 50px; cursor: pointer; margin: 10px 5px; box-shadow: 0 4px #999; transition: 0.1s; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
        .btn:active { transform: translateY(4px); box-shadow: 0 0 #666; }
        .btn:disabled { background-color: #ccc !important; color: #666; cursor: not-allowed; box-shadow: none; transform: none; }

        .btn-mic { background-color: #4CAF50; padding: 15px 30px; font-size: 20px; width: 80%; }
        .btn-sample { background-color: #2196F3; padding: 10px 20px; font-size: 16px; }
        .btn-nav { background-color: #FF9800; padding: 10px; font-size: 18px; width: 45px; height: 45px; border-radius: 50%; }

        .stars { font-size: 40px; color: #FFD700; height: 50px; margin: 5px 0; }
        .feedback { font-size: 16px; color: #555; min-height: 40px; margin-bottom: 10px; font-style: italic; padding: 5px; border: 1px dotted #ccc; border-radius: 5px;}
        
        .listening { animation: pulse 1.5s infinite; background-color: #ff5722 !important; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div class="card">
    <h1>üêª H·ªçc ph√°t √¢m üê∞</h1>
    
    <div class="img-box">
        <img id="word-img" src="" alt="Word Image" onerror="this.onerror=null; this.src='https://via.placeholder.com/300x200?text=No+Image';">
    </div>

    <div id="single-word-area">
        <h2 id="word-text">WORD</h2>
        <div class="phonetic" id="phonetic">/IPA/</div>
    </div>

    <div id="sentence-area" class="sentence-container">
        </div>

    <button class="btn btn-sample" onclick="playSampleSafe()">üîä Nghe m·∫´u</button>

    <div class="stars" id="stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
    <div class="feedback" id="feedback">ƒêang t·∫£i...</div>

    <button id="mic-btn" class="btn btn-mic" onclick="startListeningSafe()">üé§ ƒê·ªçc Ngay</button>

    <div style="margin-top: 20px; display: flex; justify-content: space-between; padding: 0 10px;">
        <button class="btn btn-nav" onclick="prevWord()">‚óÄ</button>
        <button class="btn btn-nav" onclick="nextWord()">‚ñ∂</button>
    </div>
</div>

<script>
    // --- C·∫§U TR√öC D·ªÆ LI·ªÜU M·ªöI ---
    /*
      type: 'word' (t·ª´ ƒë∆°n) ho·∫∑c 'sentence' (c√¢u)
      htmlParts: D·ªØ li·ªáu ƒë·ªÉ v·∫Ω IPA tr√™n ƒë·∫ßu ch·ªØ (ch·ªâ d√πng cho c√¢u)
    */
    const items = [
        // NH√ìM 1: √ÇM /…™r/ (ƒê√£ ƒë·ªïi th·ª© t·ª±: Beer -> Deer -> Cheer -> Tear -> Ear)
        { word: "beer", ipa: "/…™r/", img: "beer.png", type: "word", speakText: "beer", similar: ["bear", "beard", "pier", "beers"] }, 
        { word: "deer", ipa: "/…™r/", img: "deer.png", type: "word", speakText: "deer", similar: ["dear", "dare", "tear", "there"] }, 
        { word: "cheer", ipa: "/…™r/", img: "cheer.png", type: "word", speakText: "cheer", similar: ["chair", "cheers", "sheer", "chia"] }, 
        { word: "tear", ipa: "/…™r/", img: "tear.png", type: "word", speakText: "tier", similar: ["tier", "tea", "here", "tears"] }, 
        { word: "ear", ipa: "/…™r/", img: "ear.png", type: "word", speakText: "ear", similar: ["year", "here", "ears", "air", "yeah", "hear", "near"] }, 
        
        // NH√ìM 2: √ÇM /…õr/
        { word: "bear", ipa: "/…õr/", img: "bear.png", type: "word", speakText: "bear", similar: ["bare", "beer", "pair", "bears", "bar"] }, 
        { word: "pear", ipa: "/…õr/", img: "pear.png", type: "word", speakText: "pear", similar: ["pair", "pare", "bear", "pears"] }, 
        { word: "share", ipa: "/…õr/", img: "share.png", type: "word", speakText: "share", similar: ["chair", "sure", "cher", "shared"] }, 
        { word: "stair", ipa: "/…õr/", img: "stair.png", type: "word", speakText: "stair", similar: ["stare", "star", "stairs", "stay"] }, 
        { word: "chair", ipa: "/…õr/", img: "chair.png", type: "word", speakText: "chair", similar: ["cheer", "share", "chairs", "care"] },

        // NH√ìM 3: LUY·ªÜN C√ÇU (M·ªöI)
        { 
            type: "sentence",
            word: "The deer is near the chair", // D√πng ƒë·ªÉ so s√°nh k·∫øt qu·∫£ ƒë·ªçc
            img: "sentence_deer.png", // B·∫°n c·∫ßn file ·∫£nh n√†y
            // C·∫•u tr√∫c ƒë·ªÉ v·∫Ω IPA tr√™n ƒë·∫ßu ch·ªØ
            htmlParts: [
                {text: "The", ipa: "√∞…ô"},
                {text: "deer", ipa: "…™r"},
                {text: "is", ipa: "…™z"},
                {text: "near", ipa: "…™r"},
                {text: "the", ipa: "√∞…ô"},
                {text: "chair.", ipa: "t É …õr"}
            ],
            similar: ["the deer is near the chair", "deer near chair", "the dear is near the chair"]
        },
        { 
            type: "sentence",
            word: "The bear shares the pear",
            img: "sentence_bear.png", // B·∫°n c·∫ßn file ·∫£nh n√†y
            htmlParts: [
                {text: "The", ipa: "√∞…ô"},
                {text: "bear", ipa: "…õr"},
                {text: "shares", ipa: " É …õr"},
                {text: "the", ipa: "√∞…ô"},
                {text: "pear.", ipa: "…õr"}
            ],
            similar: ["the bear shares the pear", "bear shares pear", "the bear share the pear"]
        }
    ];

    let currentIndex = 0;
    let recognition;
    let recognitionTimeout;
    let audioWin, audioCorrect, audioWrong;

    window.onload = function() {
        try {
            document.getElementById('feedback').innerText = "S·∫µn s√†ng! B·∫•m n√∫t ƒë·ªÉ h·ªçc.";
            loadItem(0);
            audioWin = new Audio("win.mp3");
            audioCorrect = new Audio("correct.mp3");
            audioWrong = new Audio("wrong.mp3");
        } catch (e) {}
    };

    function loadItem(index) {
        const item = items[index];
        document.getElementById('word-img').src = item.img;
        
        // X·ª≠ l√Ω hi·ªÉn th·ªã giao di·ªán t√πy theo l√† T·ª´ hay C√¢u
        if (item.type === 'sentence') {
            document.getElementById('single-word-area').style.display = 'none';
            document.getElementById('sentence-area').style.display = 'flex';
            
            // V·∫Ω HTML cho c√¢u c√≥ IPA tr√™n ƒë·∫ßu
            const container = document.getElementById('sentence-area');
            container.innerHTML = ''; // X√≥a c≈©
            item.htmlParts.forEach(part => {
                const block = document.createElement('div');
                block.className = 'word-block';
                block.innerHTML = `
                    <div class="ipa-top">${part.ipa}</div>
                    <div class="text-bottom">${part.text}</div>
                `;
                container.appendChild(block);
            });

        } else {
            // Giao di·ªán t·ª´ ƒë∆°n b√¨nh th∆∞·ªùng
            document.getElementById('single-word-area').style.display = 'block';
            document.getElementById('sentence-area').style.display = 'none';
            document.getElementById('word-text').innerText = item.word.toUpperCase();
            document.getElementById('phonetic').innerText = item.ipa;
        }

        resetState();
    }

    function resetState() {
        document.getElementById('stars').innerText = "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ";
        document.getElementById('mic-btn').disabled = false;
        document.getElementById('mic-btn').className = "btn btn-mic";
        document.getElementById('mic-btn').innerText = "üé§ ƒê·ªçc Ngay";
        clearTimeout(recognitionTimeout);
    }

    function nextWord() {
        if (currentIndex < items.length - 1) { currentIndex++; loadItem(currentIndex); }
    }

    function prevWord() {
        if (currentIndex > 0) { currentIndex--; loadItem(currentIndex); }
    }

    function playSampleSafe() {
        try {
            window.speechSynthesis.cancel();
            const item = items[currentIndex];
            // V·ªõi c√¢u, m√°y ƒë·ªçc nguy√™n c√¢u. V·ªõi t·ª´, ƒë·ªçc theo t·ª´ g·ª£i √Ω (ƒë·ªÉ chu·∫©n √¢m)
            const textToSpeak = item.speakText || item.word;
            
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'en-US';
            utterance.rate = item.type === 'sentence' ? 0.7 : 0.8; // ƒê·ªçc c√¢u ch·∫≠m h∆°n x√≠u
            window.speechSynthesis.speak(utterance);
        } catch (e) {}
    }

    function startListeningSafe() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("B·∫°n h√£y d√πng Google Chrome (Android) ho·∫∑c Safari (iPhone) nh√©.");
            return;
        }

        try {
            window.speechSynthesis.cancel();

            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 10;
            recognition.continuous = false;

            document.getElementById('mic-btn').innerText = "üëÇ ƒêang nghe...";
            document.getElementById('mic-btn').className = "btn btn-mic listening";
            document.getElementById('mic-btn').disabled = true;
            document.getElementById('feedback').innerText = "B·∫°n ƒë·ªçc to v√† r√µ r√†ng nh√©...";

            recognition.start();

            // V·ªõi c√¢u d√†i, tƒÉng th·ªùi gian ch·ªù l√™n 10 gi√¢y
            const waitTime = items[currentIndex].type === 'sentence' ? 10000 : 8000;

            clearTimeout(recognitionTimeout);
            recognitionTimeout = setTimeout(() => {
                try { recognition.stop(); } catch(e){}
                document.getElementById('feedback').innerText = "H·∫øt gi·ªù! B·∫°n th·ª≠ l·∫°i nh√©.";
                resetBtn();
            }, waitTime); 

            recognition.onresult = function(event) {
                clearTimeout(recognitionTimeout);
                let heardWords = [];
                for(let i = 0; i < event.results[0].length; i++) {
                    heardWords.push(event.results[0][i].transcript.toLowerCase());
                }
                checkResultSmart(heardWords);
            };

            recognition.onerror = function(event) {
                clearTimeout(recognitionTimeout);
                if (event.error === 'not-allowed') {
                    alert("C·∫ßn c·∫•p quy·ªÅn Micro ƒë·ªÉ h·ªçc.");
                } else if (event.error === 'no-speech') {
                    document.getElementById('feedback').innerText = "M√°y ch∆∞a nghe r√µ. B·∫°n ƒë·ªÉ mic g·∫ßn h∆°n nh√©!";
                } else {
                    document.getElementById('feedback').innerText = "Th·ª≠ l·∫°i n√†o!";
                }
                resetBtn();
            };

            recognition.onend = function() {
                if(document.getElementById('mic-btn').disabled && document.getElementById('stars').innerText === "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ") {
                    resetBtn();
                }
            };

        } catch (e) {
            resetBtn();
        }
    }

    function checkResultSmart(heardWords) {
        const currentData = items[currentIndex];
        const targetText = currentData.word.toLowerCase();
        // Lo·∫°i b·ªè d·∫•u ch·∫•m c√¢u ƒë·ªÉ so s√°nh d·ªÖ h∆°n
        const cleanTarget = targetText.replace(/[.,]/g, "");
        const validList = currentData.similar || [];
        
        // 1. Ki·ªÉm tra ch√≠nh x√°c (5 sao)
        let isPerfect = heardWords.some(w => {
            const cleanHeard = w.replace(/[.,]/g, "");
            return cleanHeard.includes(cleanTarget) || validList.includes(cleanHeard);
        });

        if (isPerfect) {
            showResult(5, "Tuy·ªát v·ªùi! Ch√≠nh x√°c! üéâ");
            return;
        }

        // 2. Logic ch·∫•m ƒëi·ªÉm t∆∞∆°ng ƒë·ªëi
        let bestGuess = heardWords[0];
        
        if (currentData.type === 'sentence') {
            // V·ªöI C√ÇU: Ki·ªÉm tra xem c√≥ ƒë·ªçc ƒë√∫ng ƒë∆∞·ª£c > 50% s·ªë t·ª´ kh√¥ng
            const targetWordsArr = cleanTarget.split(" ");
            const heardWordsArr = bestGuess.split(" ");
            let matchCount = 0;
            targetWordsArr.forEach(tw => {
                if (bestGuess.includes(tw)) matchCount++;
            });

            if (matchCount >= targetWordsArr.length / 2) {
                showResult(3, "Kh√° l·∫Øm! (" + bestGuess + ")");
            } else {
                showResult(2, "C·ªë l√™n! M√°y nghe l√†: " + bestGuess);
            }
        } else {
            // V·ªöI T·ª™ ƒê∆†N (nh∆∞ c≈©)
            if (bestGuess.charAt(0) === targetText.charAt(0)) {
                showResult(4, "G·∫ßn ƒë√∫ng r·ªìi! (" + bestGuess + ")");
            } else {
                showResult(2, "C·ªë l√™n! M√°y nghe l√†: " + bestGuess);
            }
        }
    }

    function showResult(starCount, message) {
        let stars = "";
        for (let i = 0; i < 5; i++) {
            stars += (i < starCount) ? "‚≠ê" : "‚òÜ";
        }
        document.getElementById('stars').innerText = stars;
        document.getElementById('feedback').innerText = message;
        
        playSoundSafe(starCount);
        resetBtn();
    }

    function resetBtn() {
        document.getElementById('mic-btn').className = "btn btn-mic";
        document.getElementById('mic-btn').disabled = false;
        document.getElementById('mic-btn').innerText = "üé§ ƒê·ªçc L·∫°i";
    }

    function playSoundSafe(starCount) {
        try {
            if(audioWin) { audioWin.pause(); audioWin.currentTime = 0; }
            if(audioCorrect) { audioCorrect.pause(); audioCorrect.currentTime = 0; }
            if(audioWrong) { audioWrong.pause(); audioWrong.currentTime = 0; }

            let soundToPlay;
            if (starCount === 5) soundToPlay = audioWin;
            else if (starCount >= 3) soundToPlay = audioCorrect;
            else soundToPlay = audioWrong;

            if(soundToPlay) soundToPlay.play().catch(e => {});
        } catch (e) {}
    }
</script>

</body>
</html>
