<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªçc ti·∫øng Anh th·∫≠t d·ªÖ</title>
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #e0f7fa; text-align: center; padding: 10px; margin: 0; user-select: none; }
        
        /* Container ch√≠nh */
        .card { background: white; border-radius: 20px; padding: 15px; max-width: 600px; margin: 10px auto; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 5px solid #FFD700; min-height: 600px; position: relative; box-sizing: border-box; }
        
        /* KHU V·ª∞C HI·ªÇN TH·ªä CHUNG */
        .content-box { width: 100%; margin: 0 auto; border-radius: 15px; background: #fff; position: relative; min-height: 300px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* Style cho ·∫¢nh b√†i h·ªçc */
        #word-img { max-width: 100%; max-height: 280px; object-fit: contain; border: 2px dashed #ddd; border-radius: 15px; }

        /* Style cho GAME NATIVE */
        .game-area { width: 100%; display: none; flex-direction: column; gap: 15px; }
        .game-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        
        .game-card { 
            width: 80px; height: 80px; 
            border: 2px solid #ddd; border-radius: 10px; 
            background: #fff; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; 
            transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .game-card img { max-width: 70px; max-height: 70px; pointer-events: none; }
        .game-card.selected { border-color: #2196F3; background-color: #E3F2FD; transform: scale(1.1); box-shadow: 0 0 10px #2196F3; }
        .game-card.matched { visibility: hidden; opacity: 0; transition: 0.5s; }
        
        .word-chip { 
            padding: 10px 20px; background: #FF9800; color: white; 
            border-radius: 25px; font-weight: bold; font-size: 18px; 
            cursor: pointer; box-shadow: 0 3px #F57C00; border: none;
            transition: 0.2s;
        }
        .word-chip:active { transform: translateY(2px); box-shadow: 0 0 #F57C00; }
        .word-chip.selected { background: #2196F3; box-shadow: 0 3px #1976D2; transform: scale(1.1); }
        .word-chip.matched { visibility: hidden; opacity: 0; transition: 0.5s; }

        h1 { color: #ff6f00; font-size: 22px; margin: 10px 0; }
        
        /* Style cho T·ª´ ƒë∆°n */
        h2 { color: #333; font-size: 38px; margin: 5px 0; letter-spacing: 2px; }
        .phonetic { color: #888; font-size: 20px; margin-bottom: 10px; font-family: 'Times New Roman', serif; }

        /* Style cho C√¢u */
        .sentence-container { display: none; justify-content: center; flex-wrap: wrap; gap: 8px; margin: 15px 0; }
        .word-block { display: flex; flex-direction: column; align-items: center; }
        .ipa-top { color: #ff3b30; font-size: 16px; font-weight: bold; margin-bottom: 2px; font-family: sans-serif; }
        .text-bottom { color: #000; font-size: 26px; font-weight: normal; }
        
        /* N√∫t b·∫•m */
        .btn { border: none; border-radius: 50px; cursor: pointer; margin: 10px 5px; box-shadow: 0 4px #999; transition: 0.1s; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
        .btn:active { transform: translateY(4px); box-shadow: 0 0 #666; }
        .btn:disabled { background-color: #ccc !important; color: #666; cursor: not-allowed; box-shadow: none; transform: none; }

        .btn-mic { background-color: #4CAF50; padding: 12px 30px; font-size: 18px; width: 80%; }
        .btn-sample { background-color: #2196F3; padding: 10px 20px; font-size: 16px; }
        
        /* N√∫t ƒëi·ªÅu h∆∞·ªõng */
        .nav-container { margin-top: auto; display: flex; justify-content: space-between; padding: 10px 5px 0; width: 100%; box-sizing: border-box;}
        .btn-nav { background-color: #FF9800; padding: 0; font-size: 24px; width: 50px; height: 50px; border-radius: 50%; line-height: 50px; }

        /* Khu v·ª±c ch·∫•m ƒëi·ªÉm */
        .stars { font-size: 40px; color: #FFD700; height: 50px; margin: 5px 0; }
        .feedback { font-size: 16px; color: #555; min-height: 40px; margin-bottom: 5px; font-style: italic; padding: 5px; border: 1px dotted #ccc; border-radius: 5px;}
        
        .listening { animation: pulse 1.5s infinite; background-color: #ff5722 !important; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        /* Hi·ªáu ·ª©ng Shake khi sai */
        .shake { animation: shake 0.5s; background-color: #ffcdd2 !important; border-color: red !important; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
    </style>
</head>
<body>

<div class="card">
    <h1 id="header-title">üêª H·ªçc ph√°t √¢m üê∞</h1>
    
    <div class="content-box" id="content-box">
        <img id="word-img" src="" alt="H√¨nh ·∫£nh minh h·ªça">
        
        <div id="game-area" class="game-area">
            <div style="margin-bottom: 10px; color: #555;">B·∫•m v√†o <b>H√¨nh</b> r·ªìi ch·ªçn <b>T·ª´</b> ƒë√∫ng nh√©!</div>
            <div id="game-images" class="game-row"></div>
            <hr style="width: 50%; border-top: 1px dashed #ccc; margin: 15px auto;">
            <div id="game-words" class="game-row"></div>
            <div id="game-win-msg" style="display:none; color: green; font-size: 24px; font-weight: bold; margin-top: 20px;">üéâ CHI·∫æN TH·∫ÆNG! üéâ</div>
        </div>
    </div>

    <div id="learning-section">
        <div id="single-word-area">
            <h2 id="word-text">...</h2>
            <div class="phonetic" id="phonetic">...</div>
        </div>
        <div id="sentence-area" class="sentence-container"></div>
        <button class="btn btn-sample" onclick="playSampleSafe()">üîä Nghe m·∫´u</button>
        <div class="stars" id="stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
        <div class="feedback" id="feedback">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        <button id="mic-btn" class="btn btn-mic" onclick="startListeningSafe()">üé§ ƒê·ªçc Ngay</button>
    </div>

    <div id="game-controls" style="display:none; margin-top:10px;">
        <button class="btn" style="background-color: #9C27B0;" onclick="setupGame()">üîÑ Ch∆°i L·∫°i</button>
    </div>

    <div class="nav-container">
        <button class="btn btn-nav" onclick="prevItem()">‚óÄ</button>
        <button class="btn btn-nav" onclick="nextItem()">‚ñ∂</button>
    </div>
</div>

<script>
    // --- DANH S√ÅCH B√ÄI H·ªåC & GAME DATA ---
    const items = [
        // NH√ìM 1: √ÇM /…™r/
        { word: "beer", ipa: "/…™r/", img: "beer.png", type: "word", speakText: "beer", similar: ["bear", "beard", "pier", "beers"] }, 
        { word: "deer", ipa: "/…™r/", img: "deer.png", type: "word", speakText: "deer", similar: ["dear", "dare", "tear", "there"] }, 
        { word: "cheer", ipa: "/…™r/", img: "cheer.png", type: "word", speakText: "cheer", similar: ["chair", "cheers", "sheer", "chia"] }, 
        { word: "tear", ipa: "/…™r/", img: "tear.png", type: "word", speakText: "tier", similar: ["tier", "tea", "here", "tears"] }, 
        { word: "ear", ipa: "/…™r/", img: "ear.png", type: "word", speakText: "ear", similar: ["year", "here", "ears", "air", "yeah", "hear", "near"] }, 
        
        // NH√ìM 2: √ÇM /…õr/
        { word: "bear", ipa: "/…õr/", img: "bear.png", type: "word", speakText: "bear", similar: ["bare", "beer", "pair", "bears", "bar"] }, 
        { word: "pear", ipa: "/…õr/", img: "pear.png", type: "word", speakText: "pear", similar: ["pair", "pare", "bear", "pears"] }, 
        { word: "share", ipa: "/…õr/", img: "share.png", type: "word", speakText: "share", similar: ["chair", "sure", "cher", "shared"] }, 
        { word: "stair", ipa: "/…õr/", img: "stair.png", type: "word", speakText: "stair", similar: ["stare", "star", "stairs", "stay"] }, 
        { word: "chair", ipa: "/…õr/", img: "chair.png", type: "word", speakText: "chair", similar: ["cheer", "share", "chairs", "care"] },

        // NH√ìM 3: C√ÇU
        { 
            type: "sentence",
            word: "The deer is near the chair", 
            img: "sentence_deer.png",
            htmlParts: [ {text: "The", ipa: "√∞…ô"}, {text: "deer", ipa: "…™r"}, {text: "is", ipa: "…™z"}, {text: "near", ipa: "…™r"}, {text: "the", ipa: "√∞…ô"}, {text: "chair.", ipa: "t É …õr"} ],
            similar: ["the deer is near the chair", "deer near chair"]
        },
        { 
            type: "sentence",
            word: "The bear shares the pear",
            img: "sentence_bear.png",
            htmlParts: [ {text: "The", ipa: "√∞…ô"}, {text: "bear", ipa: "…õr"}, {text: "shares", ipa: " É …õr"}, {text: "the", ipa: "√∞…ô"}, {text: "pear.", ipa: "…õr"} ],
            similar: ["the bear shares the pear", "bear shares pear"]
        },

        // NH√ìM 4: GAME T·ª∞ T·∫†O (NATIVE)
        { 
            type: "game", 
            title: "Tr√≤ ch∆°i gh√©p h√¨nh /…™r/", 
            gameData: ["beer", "deer", "cheer", "tear", "ear"] // Danh s√°ch t·ª´ c·∫ßn gh√©p
        },
        { 
            type: "game", 
            title: "Tr√≤ ch∆°i gh√©p h√¨nh /…õr/", 
            gameData: ["bear", "pear", "share", "stair", "chair"] // Danh s√°ch t·ª´ c·∫ßn gh√©p
        }
    ];

    let currentIndex = 0;
    let recognition;
    let recognitionTimeout;
    let audioWin, audioCorrect, audioWrong;
    
    // Bi·∫øn cho Game
    let selectedImg = null;
    let selectedWord = null;
    let matchedCount = 0;

    window.onload = function() {
        try {
            document.getElementById('feedback').innerText = "S·∫µn s√†ng! B·∫•m n√∫t ƒë·ªÉ h·ªçc.";
            loadItem(0, false);
            audioWin = new Audio("win.mp3");
            audioCorrect = new Audio("correct.mp3");
            audioWrong = new Audio("wrong.mp3");
        } catch (e) { alert("L·ªói: " + e); }
    };

    function loadItem(index, autoPlay = true) {
        const item = items[index];
        const learningSection = document.getElementById('learning-section');
        const gameArea = document.getElementById('game-area');
        const gameControls = document.getElementById('game-controls');
        const imgEl = document.getElementById('word-img');

        window.speechSynthesis.cancel();
        resetState();

        if (item.type === 'game') {
            // --- CH·∫æ ƒê·ªò GAME ---
            document.getElementById('header-title').innerText = "üéÆ " + item.title;
            learningSection.style.display = 'none';
            imgEl.style.display = 'none';
            gameArea.style.display = 'flex'; // Hi·ªán game native
            gameControls.style.display = 'block';
            
            setupGame(); // Kh·ªüi t·∫°o game

        } else {
            // --- CH·∫æ ƒê·ªò H·ªåC ---
            document.getElementById('header-title').innerText = "üêª H·ªçc ph√°t √¢m üê∞";
            learningSection.style.display = 'block';
            imgEl.style.display = 'block';
            gameArea.style.display = 'none';
            gameControls.style.display = 'none';
            imgEl.src = item.img;

            if (item.type === 'sentence') {
                document.getElementById('single-word-area').style.display = 'none';
                document.getElementById('sentence-area').style.display = 'flex';
                const container = document.getElementById('sentence-area');
                container.innerHTML = ''; 
                item.htmlParts.forEach(part => {
                    const block = document.createElement('div');
                    block.className = 'word-block';
                    block.innerHTML = `<div class="ipa-top">${part.ipa}</div><div class="text-bottom">${part.text}</div>`;
                    container.appendChild(block);
                });
            } else {
                document.getElementById('single-word-area').style.display = 'block';
                document.getElementById('sentence-area').style.display = 'none';
                document.getElementById('word-text').innerText = item.word.toUpperCase();
                document.getElementById('phonetic').innerText = item.ipa;
            }

            if(autoPlay) setTimeout(() => { playSampleSafe(); }, 500);
        }
    }

    // --- LOGIC GAME NATIVE ---
    function setupGame() {
        const currentItem = items[currentIndex];
        const targetWords = currentItem.gameData; // ["ear", "beer"...]
        const imgContainer = document.getElementById('game-images');
        const wordContainer = document.getElementById('game-words');
        const winMsg = document.getElementById('game-win-msg');
        
        // Reset
        imgContainer.innerHTML = "";
        wordContainer.innerHTML = "";
        winMsg.style.display = "none";
        selectedImg = null;
        selectedWord = null;
        matchedCount = 0;

        // T·∫°o danh s√°ch tr·ªôn ng·∫´u nhi√™n
        let shuffledImages = [...targetWords].sort(() => Math.random() - 0.5);
        let shuffledWords = [...targetWords].sort(() => Math.random() - 0.5);

        // Render H√¨nh ·∫£nh
        shuffledImages.forEach(wordKey => {
            // T√¨m object g·ªëc ƒë·ªÉ l·∫•y link ·∫£nh
            let originalObj = items.find(i => i.word === wordKey);
            
            let card = document.createElement('div');
            card.className = 'game-card';
            card.dataset.key = wordKey;
            card.innerHTML = `<img src="${originalObj.img}">`;
            card.onclick = () => selectCard(card, 'img');
            imgContainer.appendChild(card);
        });

        // Render T·ª´ v·ª±ng
        shuffledWords.forEach(wordKey => {
            let chip = document.createElement('button');
            chip.className = 'word-chip';
            chip.innerText = wordKey.toUpperCase();
            chip.dataset.key = wordKey;
            chip.onclick = () => selectCard(chip, 'word');
            wordContainer.appendChild(chip);
        });
    }

    function selectCard(el, type) {
        // N·∫øu ƒë√£ ƒë√∫ng r·ªìi th√¨ kh√¥ng b·∫•m ƒë∆∞·ª£c n·ªØa
        if(el.classList.contains('matched')) return;

        // X·ª≠ l√Ω ch·ªçn
        if (type === 'img') {
            if (selectedImg) selectedImg.classList.remove('selected');
            selectedImg = el;
            selectedImg.classList.add('selected');
        } else {
            if (selectedWord) selectedWord.classList.remove('selected');
            selectedWord = el;
            selectedWord.classList.add('selected');
        }

        // Ki·ªÉm tra gh√©p ƒë√¥i
        if (selectedImg && selectedWord) {
            checkMatch();
        }
    }

    function checkMatch() {
        const imgKey = selectedImg.dataset.key;
        const wordKey = selectedWord.dataset.key;

        if (imgKey === wordKey) {
            // ƒê√öNG
            playSoundSafeLocal('correct');
            selectedImg.classList.add('matched');
            selectedWord.classList.add('matched');
            selectedImg.classList.remove('selected');
            selectedWord.classList.remove('selected');
            selectedImg = null;
            selectedWord = null;
            matchedCount++;
            
            // ƒê·ªçc t·ª´ ƒë√≥ l√™n
            let u = new SpeechSynthesisUtterance(imgKey);
            u.lang = 'en-US';
            window.speechSynthesis.speak(u);

            // Ki·ªÉm tra th·∫Øng
            if (matchedCount === 5) {
                setTimeout(() => {
                    document.getElementById('game-win-msg').style.display = 'block';
                    playSoundSafeLocal('win');
                }, 500);
            }

        } else {
            // SAI
            playSoundSafeLocal('wrong');
            // Hi·ªáu ·ª©ng rung l·∫Øc
            selectedImg.classList.add('shake');
            selectedWord.classList.add('shake');
            setTimeout(() => {
                selectedImg.classList.remove('shake', 'selected');
                selectedWord.classList.remove('shake', 'selected');
                selectedImg = null;
                selectedWord = null;
            }, 500);
        }
    }

    // --- C√ÅC H√ÄM H·ªñ TR·ª¢ KH√ÅC ---
    function nextItem() { if (currentIndex < items.length - 1) { currentIndex++; loadItem(currentIndex, true); } }
    function prevItem() { if (currentIndex > 0) { currentIndex--; loadItem(currentIndex, true); } }
    function resetState() { document.getElementById('stars').innerText = "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ"; document.getElementById('mic-btn').disabled = false; document.getElementById('mic-btn').innerText = "üé§ ƒê·ªçc Ngay"; clearTimeout(recognitionTimeout); }
    
    function playSampleSafe() {
        if(items[currentIndex].type === 'game') return;
        try {
            window.speechSynthesis.cancel();
            const item = items[currentIndex];
            const textToSpeak = item.speakText || item.word;
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'en-US';
            utterance.rate = item.type === 'sentence' ? 0.7 : 0.8;
            window.speechSynthesis.speak(utterance);
        } catch (e) {}
    }

    function startListeningSafe() {
        if(items[currentIndex].type === 'game') return;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) { alert("D√πng Chrome/Safari nh√©."); return; }
        try {
            window.speechSynthesis.cancel();
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 10;
            recognition.continuous = false;
            document.getElementById('mic-btn').innerText = "üëÇ ƒêang nghe...";
            document.getElementById('mic-btn').disabled = true;
            recognition.start();
            const waitTime = items[currentIndex].type === 'sentence' ? 10000 : 8000;
            clearTimeout(recognitionTimeout);
            recognitionTimeout =
